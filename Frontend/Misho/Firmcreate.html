<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TanqTasks | Create Firm</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- FIX: Prevent favicon 404 -->
  <link rel="icon"
        href='data:image/svg+xml;utf8,
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
          <rect width="64" height="64" rx="12" ry="12" fill="%230d8f9a"/>
          <text x="50%" y="54%" font-size="36" text-anchor="middle" fill="white"
                font-family="Segoe UI, sans-serif">T</text>
        </svg>' />

  <style>
    :root {
      --yellow:#ffd247; --yellow-dark:#e0b633;
      --teal:#0d8f9a; --blue-line:#0d8f9a40;
      --gray-900:#111827; --gray-700:#374151;
      --gray-500:#6b7280; --gray-200:#e5e7eb;
      --gray-50:#f8f9fb;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",system-ui,sans-serif}
    body{background:var(--gray-50);color:var(--gray-900);min-height:100vh;display:flex;flex-direction:column}

    .header{padding:18px 32px;border-bottom:2px solid var(--gray-200);display:flex;align-items:center}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700;font-size:24px}
    .logo i{color:var(--yellow-dark)}  .logo span{color:var(--teal)}
    .header::after{content:"";display:block;height:2px;background:var(--blue-line)}

    nav{
      width:92px;height:100vh;position:fixed;right:0;top:0;background:#fff;
      border-left:2px solid var(--gray-200);box-shadow:-6px 0 10px rgba(0,0,0,.04);
      display:flex;flex-direction:column;justify-content:space-between;padding:36px 0;z-index:90
    }
    .nav-links{display:flex;flex-direction:column;align-items:center;gap:38px}
    .nav-link{
      text-decoration:none;font-size:23px;color:var(--gray-500);width:100%;display:flex;justify-content:center;
      padding:8px 0;border-left:2px solid transparent;transition:.25s
    }
    .nav-link:hover{color:var(--teal);background:var(--gray-50);border-left-color:var(--yellow)}
    .account-icon{width:48px;height:48px;background:var(--teal);color:#fff;display:flex;align-items:center;justify-content:center}

    .main-area{flex:1;display:flex;gap:48px;padding:48px;margin-right:92px}
    .form-panel{
      flex:1;background:#fff;border:2px solid var(--gray-200);padding:48px;position:relative;
      box-shadow:0 6px 16px rgba(0,0,0,.06)
    }
    .form-panel::before{content:"";position:absolute;inset:0;border:2px solid var(--blue-line);
                        transform:translate(10px,10px);z-index:-1}
    .form-panel h2{
      font-size:24px;margin-bottom:24px;color:var(--gray-900);
      border-bottom:2px solid var(--yellow);display:inline-block;padding-bottom:4px
    }
    .form-group{margin-bottom:24px}
    .form-group label{display:block;margin-bottom:6px;font-size:14px;color:var(--gray-700)}
    .form-group input,.form-group textarea{width:100%;padding:12px;border:1px solid var(--gray-200);font-size:14px}
    .btn-create{padding:14px 28px;background:var(--teal);border:none;color:#fff;font-weight:600;cursor:pointer}
    .msg{margin-top:18px;font-size:14px;display:none}
    .msg.ok{color:#179c4d}.msg.err{color:#e12d39}

    .stats-col{width:240px;display:flex;flex-direction:column;gap:32px;align-items:center}
    .stat-card{width:100%;background:#fff;border:2px solid var(--gray-200);padding:24px;position:relative;
               box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .stat-card::before{content:"";position:absolute;inset:0;border:2px solid var(--blue-line);
                       transform:translate(6px,6px);z-index:-1}
    .stat-title{font-size:12px;color:var(--gray-500);margin-bottom:8px}
    .stat-value{font-size:24px;font-weight:700;color:var(--gray-700)}
    .stat-change{font-size:12px;margin-top:10px;color:#2ecc71}

    @media(max-width:920px){
      .main-area{flex-direction:column;margin-right:92px}
      .stats-col{flex-direction:row;width:auto;overflow-x:auto;padding-bottom:8px}
      .stat-card{min-width:180px}
    }
    @media(max-width:640px){
      nav{width:70px}.main-area{padding:32px;margin-right:70px}
    }
  </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="logo"><i class="fas fa-tasks"></i><span>Create Firm</span></div>
</div>

<!-- MAIN -->
<div class="main-area">
  <div class="form-panel">
    <h2>Create Firm</h2>
    <div class="form-group">
      <label for="name">Firm Name *</label>
      <input id="name" placeholder="Acme Inc.">
    </div>
    <div class="form-group">
      <label for="desc">Description</label>
      <textarea id="desc" rows="4" placeholder="Describe your firm…"></textarea>
    </div>
    <button class="btn-create" id="createBtn">Create Firm</button>
    <p class="msg ok"  id="msgOk">Firm created ✔</p>
    <p class="msg err" id="msgErr"></p>
  </div>

  <div class="stats-col" id="statsCol">
    <div class="stat-card">
      <div class="stat-title">Total Firms</div>
      <div class="stat-value" id="statFirms">—</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">My Projects</div>
      <div class="stat-value" id="statProjects">—</div>
    </div>
  </div>
</div>

<!-- SIDEBAR NAV -->
<nav>
  <div class="nav-links">
    <div class="account-icon"><i class="fas fa-user"></i></div>
    <a href="#" class="nav-link"><i class="fas fa-home"></i></a>
    <a href="#" class="nav-link"><i class="fas fa-project-diagram"></i></a>
    <a href="#" class="nav-link"><i class="fas fa-tasks"></i></a>
    <a href="#" class="nav-link"><i class="fas fa-info-circle"></i></a>
    <a href="#" class="nav-link"><i class="fas fa-cog"></i></a>
  </div>
</nav>

<!-- SCRIPT -->
<script type="module">
import { fetchWithAuth } from "../Marto/auth.mjs";

const $ = id => document.getElementById(id);
const msgOk  = $('msgOk');
const msgErr = $('msgErr');

$('createBtn').addEventListener('click', async ()=>{
  msgOk.style.display = msgErr.style.display = 'none';
  const name = $('name').value.trim();
  const desc = $('desc').value.trim();
  if(!name){
    msgErr.textContent = 'Please enter a firm name';
    msgErr.style.display = 'block';
    return;
  }

  const url = `http://127.0.0.1:8000/api/firm/firms/create/?name=${encodeURIComponent(name)}&description=${encodeURIComponent(desc)}`;

  try {
    const r = await fetchWithAuth(url, { method: 'POST' });
    const res = await r.json();
    if (!r.ok) {
      msgErr.textContent = res.error || res.detail || 'Server error';
      msgErr.style.display = 'block';
      return;
    }
    msgOk.style.display = 'block';
    $('name').value = ''; $('desc').value = '';
    updateStats();
  } catch (e) {
    msgErr.textContent = 'Network error – try again';
    msgErr.style.display = 'block';
  }
});

async function updateStats(){
  const username = localStorage.getItem('username');
  if(!username) return;

  const rf = await fetchWithAuth(`http://127.0.0.1:8000/api/firm/firms/by-user/?user=${encodeURIComponent(username)}`);
  const firms = await rf.json();
  if(rf.ok) $('statFirms').textContent = firms.length;

  const rt = await fetchWithAuth(`http://127.0.0.1:8000/api/firm/tasks/by-name/`);
  const tasks = await rt.json();
  if(rt.ok) $('statProjects').textContent = tasks.length;
}

updateStats();
</script>
</body>
</html>
