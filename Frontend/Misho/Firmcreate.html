<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TanqTasks | Create Firm</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- FIX: Prevent favicon 404 -->
  <link rel="icon"
        href='data:image/svg+xml;utf8,
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64">
          <rect width="64" height="64" rx="12" ry="12" fill="%230d8f9a"/>
          <text x="50%" y="54%" font-size="36" text-anchor="middle" fill="white"
                font-family="Segoe UI, sans-serif">T</text>
        </svg>' />

  <style>
    :root {
      --yellow:#ffd247; --yellow-dark:#e0b633;
      --teal:#0d8f9a; --blue-line:#0d8f9a40;
      --gray-900:#111827; --gray-700:#374151;
      --gray-500:#6b7280; --gray-200:#e5e7eb;
      --gray-50:#f8f9fb;
      --collapsed:5.75rem;
      --expanded:15rem;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",system-ui,sans-serif}
    body{background:var(--gray-50);color:var(--gray-900);min-height:100vh;display:flex;flex-direction:column}

    .header{padding:1.125rem 2rem;border-bottom:.125rem solid var(--gray-200);display:flex;align-items:center;background:var(--gray-50)}
    .logo{display:flex;align-items:center;gap:.625rem;font-weight:700;font-size:1.5rem}
    .logo i{color:var(--yellow-dark)}  .logo span{color:var(--teal)}
    .header::after{content:"";display:block;height:.125rem;background:var(--blue-line)}

    /* SIDEBAR */
    nav#sidebar{
      width:var(--collapsed);height:100vh;right:0;top:0;position:fixed;z-index:1200;
      background:#fff;border-left:.125rem solid var(--gray-200);box-shadow:-.375rem 0 .625rem rgba(0,0,0,.04);
      display:flex;flex-direction:column;padding-top:1.125rem;transition:.25s
    }
    body.nav-open nav#sidebar{width:var(--expanded)}
    #navToggle{
      background:none;border:none;color:var(--gray-500);font-size:1.375rem;
      margin-bottom:2rem;padding:0 1.5rem;cursor:pointer;transition:.25s
    }
    body.nav-open #navToggle{transform:rotate(90deg)}
    .nav-links{display:flex;flex-direction:column;gap:1rem}
    .nav-link{
      display:flex;align-items:center;gap:.75rem;padding:.75rem 1.5rem;
      color:var(--gray-500);text-decoration:none;transition:.25s;position:relative
    }
    .nav-link .label{opacity:0;transform:translateX(.5rem);transition:.25s;white-space:nowrap}
    body.nav-open .nav-link .label{opacity:1;transform:none}
    body:not(.nav-open) .nav-link .label{display:none}
    .nav-link:hover{color:var(--teal);background:var(--gray-50)}
    .nav-link::before{
      content:"";position:absolute;left:0;top:0;width:.25rem;background:transparent;transition:.25s
    }
    .nav-link:hover::before{background:var(--yellow);height:100%}
    .nav-link.active{color:var(--teal);background:transparent}
    .nav-link.active::before{
      background:var(--yellow);
      width:.25rem;
      height:1.5rem;
      top:50%;
      transform:translateY(-50%);
    }
    .nav-link i{font-size:1.25rem;width:1.5rem;text-align:center;color:inherit}
    body:not(.nav-open) .nav-link{justify-content:center;padding:.75rem 0;gap:0}
    #pageShade{
      position:fixed;inset:0;background:rgba(0,0,0,.3);backdrop-filter:blur(2px);
      opacity:0;pointer-events:none;transition:.3s;z-index:1100
    }
    body.nav-open #pageShade{opacity:1;pointer-events:auto}

    .main-area{flex:1;display:flex;gap:48px;padding:48px;margin-right:var(--collapsed);transition:.25s;}
    body.nav-open .main-area{margin-right:var(--expanded);}
    .form-panel{
      flex:1;background:#fff;border:2px solid var(--gray-200);padding:48px;position:relative;
      box-shadow:0 6px 16px rgba(0,0,0,.06)
    }
    .form-panel::before{content:"";position:absolute;inset:0;border:2px solid var(--blue-line);
                        transform:translate(10px,10px);z-index:-1}
    .form-panel h2{
      font-size:24px;margin-bottom:24px;color:var(--gray-900);
      border-bottom:2px solid var(--yellow);display:inline-block;padding-bottom:4px
    }
    .form-group{margin-bottom:24px}
    .form-group label{display:block;margin-bottom:6px;font-size:14px;color:var(--gray-700)}
    .form-group input,.form-group textarea{width:100%;padding:12px;border:1px solid var(--gray-200);font-size:14px}
    .btn-create{padding:14px 28px;background:var(--teal);border:none;color:#fff;font-weight:600;cursor:pointer}
    .msg{margin-top:18px;font-size:14px;display:none}
    .msg.ok{color:#179c4d}.msg.err{color:#e12d39}

    .stats-col{width:240px;display:flex;flex-direction:column;gap:32px;align-items:center}
    .stat-card{width:100%;background:#fff;border:2px solid var(--gray-200);padding:24px;position:relative;
               box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .stat-card::before{content:"";position:absolute;inset:0;border:2px solid var(--blue-line);
                       transform:translate(6px,6px);z-index:-1}
    .stat-title{font-size:12px;color:var(--gray-500);margin-bottom:8px}
    .stat-value{font-size:24px;font-weight:700;color:var(--gray-700)}
    .stat-change{font-size:12px;margin-top:10px;color:#2ecc71}

    @media(max-width:920px){
      .main-area{flex-direction:column;margin-right:var(--collapsed)}
      .stats-col{flex-direction:row;width:auto;overflow-x:auto;padding-bottom:8px}
      .stat-card{min-width:180px}
    }
    @media(max-width:640px){
      nav#sidebar{width:70px}.main-area{padding:32px;margin-right:70px}
    }
  </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="logo"><i class="fas fa-tasks"></i><span>Create Firm</span></div>
</div>

<!-- MAIN -->
<div class="main-area">
  <div class="form-panel">
    <h2>Create Firm</h2>
    <div class="form-group">
      <label for="name">Firm Name *</label>
      <input id="name" placeholder="Acme Inc.">
    </div>
    <div class="form-group">
      <label for="desc">Description</label>
      <textarea id="desc" rows="4" placeholder="Describe your firm…"></textarea>
    </div>
    <button class="btn-create" id="createBtn">Create Firm</button>
    <p class="msg ok"  id="msgOk">Firm created ✔</p>
    <p class="msg err" id="msgErr"></p>
  </div>

  <div class="stats-col" id="statsCol">
    <div class="stat-card">
      <div class="stat-title">Total Firms</div>
      <div class="stat-value" id="statFirms">—</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">My Projects</div>
      <div class="stat-value" id="statProjects">—</div>
    </div>
  </div>
</div>

<!-- SIDEBAR NAV -->
<nav id="sidebar">
  <button id="navToggle" aria-label="toggle navigation"><i class="fas fa-bars"></i></button>
  <div class="nav-links">
    <a href="../Misho/logedinoage.html" class="nav-link"><i class="fas fa-home"></i><span class="label">Home</span></a>
    <a href="../ivan/displaytasks.html" class="nav-link"><i class="fas fa-tasks"></i><span class="label">My Tasks</span></a>
    <a href="../Marto/invites.html" class="nav-link"><i class="fas fa-envelope-open-text"></i><span class="label">Invites</span></a>
    <a href="../Marto/projmanage.html" class="nav-link"><i class="fas fa-project-diagram"></i><span class="label">Projects</span></a>
    <a href="../Misho/Firmcreate.html" class="nav-link active"><i class="fas fa-building"></i><span class="label">Create Firm</span></a>
    <a href="../Misho/Support.html" class="nav-link"><i class="fas fa-life-ring"></i><span class="label">Support</span></a>
  </div>
</nav>
<div id="pageShade"></div>

<!-- SCRIPT -->
<script type="module">
import { fetchWithAuth } from "../Marto/auth.mjs";

const $ = id => document.getElementById(id);
const msgOk  = $('msgOk');
const msgErr = $('msgErr');

document.getElementById("navToggle").onclick = () => {
  document.body.classList.toggle("nav-open");
};
document.getElementById("pageShade").onclick = () => {
  document.body.classList.remove("nav-open");
};

$('createBtn').addEventListener('click', async ()=>{
  msgOk.style.display = msgErr.style.display = 'none';
  const name = $('name').value.trim();
  const desc = $('desc').value.trim();
  if(!name){
    msgErr.textContent = 'Please enter a firm name';
    msgErr.style.display = 'block';
    return;
  }

  const url = `http://127.0.0.1:8000/api/firm/firms/create/?name=${encodeURIComponent(name)}&description=${encodeURIComponent(desc)}`;

  try {
    const r = await fetchWithAuth(url, { method: 'POST' });
    const res = await r.json();
    if (!r.ok) {
      msgErr.textContent = res.error || res.detail || 'Server error';
      msgErr.style.display = 'block';
      return;
    }
    msgOk.style.display = 'block';
    $('name').value = ''; $('desc').value = '';
    updateStats();
  } catch (e) {
    msgErr.textContent = 'Network error – try again';
    msgErr.style.display = 'block';
  }
});

async function updateStats(){
  const username = localStorage.getItem('username');
  if(!username) return;

  const rf = await fetchWithAuth(`http://127.0.0.1:8000/api/firm/firms/by-user/?user=${encodeURIComponent(username)}`);
  const firms = await rf.json();
  if(rf.ok) $('statFirms').textContent = firms.length;

  const rt = await fetchWithAuth(`http://127.0.0.1:8000/api/firm/tasks/by-name/`);
  const tasks = await rt.json();
  if(rt.ok) $('statProjects').textContent = tasks.length;
}

updateStats();
</script>
</body>
</html>
